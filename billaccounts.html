<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paidit | Bills</title>
    <link rel="stylesheet" href="css/billaccounts.css" />
    <link rel="stylesheet" href="css/foundation.css" />
    <link rel="stylesheet" href="css/responsive-tables.css"/>
    <link rel="stylesheet" href="css/test.css"/>
    
    <script type="text/javascript" src="js/bills.js"></script>
    <script type="text/javascript" src="js/responsive-tables.js"></script>
    <link rel="shortcut icon" href="img/icon/checkMark.png"/>

    <script src="js/vendor/modernizr.js"></script>
  </head>
  <body onload="getBills()">
    
      
      <div class="icon-bar five-up">
        <a class="item" href="index.html">
          <img src="img/icon/homeIconG.png" height="20" width="20"  >
          <label class="show-for-medium-up">Home</label>
        </a>
        <a class="item" href="analysis.html">
          <img src="img/icon/chartsIconG.png" height="20" width="20">
          <label class="show-for-medium-up">Bill Analysis</label>
        </a>
        <a class="item" href="billaccounts.html" id="bills">
          <img src="img/icon/billIconG.png" height="20" width="20">
          <label class="show-for-medium-up" id="billstext"><b>Bills</b></label>
        </a>
        <a class="item" href="notificationslog.html">
          <img src="img/icon/smsIconG.png" height="20" width="20">
          <label class="show-for-medium-up">Notification Log</label>
        </a>
        <a class="item" href="usersettings.html">
          <img src="img/icon/gearIconG.png" height="20" width="20">
          <label class="show-for-medium-up">Settings</label>
        </a>
      </div>
   

    <div class="container navigation" style = "width:100%; margin:2% 0% 0% 0%">

      
      <div class="small-12 small-centered large-12 large-centered columns">
        <div class="large-1 columns" align = "center">
          <a href="#" class='button radius' id='addBill' >Add Bill</a>
        </div>
          <!-- BILL LIST -->
        <table class="small-11 large-11 columns" id="billTable" name = "billTable">
          <thead  id="billTableHeader">
            <tr>
              <th width="10%">Bill</th>
              <th width="13%">Amount</th>
              <th width="16%" style="text-align:center;">Due Date</th>
              <th width="14%" style="text-align:center;">Due Time</th>
              <th width="14%">Notifications</th>
              <th width="16%">Repeat</th>
              <th width = "17%"></th>
            </tr>
          </thead>
          <tbody >
            <tr>
              <td style="font-size:110%;"><b>Example Bill</b></td>
              <td style="font-size:110%;"><b>$55.00 - $65.00</b></td>
              <td style="font-size:110%;text-align:center"><b>05/19/2099</b></td>
              <!--<td ><img src="img/icon/emailIcon40px.png"/>
              <img src="img/icon/smsIcon40px.png"/>
              </td> -->
              
              <td style="font-size:110%;text-align:center"><b>12:55 p.m.</b></td>
              
              <td style="font-size:110%;"><b>MyEmail,Cell</b></td>
              <td style="font-size:110%;"><b>Monthly</b></td>
            
              <td><button style="width:60px;padding: 20px 0px 20px 0px;" id="edit">Edit</button> <button style="width:85px;padding: 20px 0px 20px 0px;">Delete</button></td>
              <!-- <td class="editBox"><img src="img/icon/editIcon40px.png" /></td> -->
              </tr>
              
            </tbody>
        </table>
        
        <a href="#" class="button radius" id="saveEdit">Save</a> <!-- saveEdit saves the edited bill-->
        <a href="#" class="button radius" id="cancelEdit">Cancel</a>        
          
        <a href="#" class="button radius" id="saveBtn">Save</a> <!-- saveBtn saves the new bill-->
        <a href="#" class="button radius" id="cancelBtn">Cancel</a>
      </div> 
    </div>

    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    
    <script>
      $(document).foundation();
      
      var returnBills=""; //saved bill object from backend used for this page
      
      function setCookie(cname,cvalue,exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname+"="+cvalue+"; "+expires;
      }
 
      var i;
      var allBills; //{"bills":[]} allBills that are NOT Paid are in array
      var numBills; //number of bills that are NOT Paid
      var obj; //JSON object of all bills that are NOT Paid (javascript object)
      var objOld; // justin: for storing old verison during edits
      var mes; // for creating log messages
      var billRows = [];
      var backendURL = "https://pdit-backend-jcskillings.c9.io/"; // hey justin
      //var backendURL = "https://stormy-reef-9988.herokuapp.com/";
      function billRow(billIndex, billId, tableRow){
        this.billIndex = billIndex;
        this.billId = billId;
        this.tableRow = tableRow;
      }
      // GET BILLS - Runs on pageload gets all bills stored in cookies ========================
      function getBills() {
        /*if(getCookie("currUser") == "" || getCookie("currUser") == null || getCookie("currUser") =='{"bills":[]}') {
          window.location.replace("splash.html");
        } */
        if(getCookie("currUser") == "" || getCookie("currUser") == null ) {
          window.location.replace("splash.html");
        }
        else {
        var user = JSON.parse(getCookie("currUser"));
        var username = {"user_name": user.username };
        
        getBillsHTTP2(username).done(getBillsCallback);
        /* if (getCookie("allBills") == null || getCookie("allBills") =="" || getCookie("allBills") == '{"bills":[]}'){
          setCookie("allBills",'{"bills":[]}',30);
          allBills = '{"bills":[]}';
          numBills = 0;
          numPaid = 0;
          paidJson = "";
        }
        else {
          deleteOldPaid();
          updateBillsNoPaid(); 
          for  (i=0; i < numBills; i++){
            putBill(i);
          } */
        } 
      } // end getBills() 
      
      //sets returned bills from backend return value
      function getBillsCallback(data){
        // anything in getBills() that relies on json from the backend must go in here
        returnBills = {"bills": data };
        //alert("bill 4 date: " + returnBills.bills[4].dueDate + " name: " + returnBills.bills[4].name);
        //alert("UTC version: " + Date.UTC(2015,5,31,8,0).toString());
        if (returnBills == null || returnBills =="" || returnBills == '{"bills":[]}'){
          //setCookie("allBills",'{"bills":[]}',30);
          allBills = '{"bills":[]}';
          numBills = 0;
          numPaid = 0;
          paidJson = "";
        }
        else {
          deleteOldPaid();
          updateBillsNoPaid(); 
          for  (i=0; i < numBills; i++){
            putBill(i);
            //alert("billRows: " + billRows.valueOf());
          }
          //alert("billRows[0].billId: " + billRows[0].billId + " row: " + billRows[0].tableRow );
          //alert("billRows[1].billId: " + billRows[1].billId + " row: " + billRows[1].tableRow );

        }
      } // end getBillsCallback
      
      //ajax for getting bills
      function getBillsHTTP2(user_name){
        //alert("usernmae in http2 is:" + JSON.stringify(user_name));
        return $.ajax({
          type: "GET",
          dataType: 'json',
          //url: 'https://pdit-backend-jcskillings.c9.io/bills.json',
          url: backendURL+'bills.json',
          data: user_name,
          contentType: 'application/json',
          //success: callback
          });
      } // end getBillsHTTP2
      
      function putBill(index) { // displays bills in table, called by getBillsCallback ======================================
        var table = document.getElementById("billTable");
        var row = table.insertRow(index+2);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        var cell5 = row.insertCell(4);
        var cell6 = row.insertCell(5);
        var cell7 = row.insertCell(6);
        var dueD = obj.bills[index].dueDate;
        billRows.push(new billRow(index, obj.bills[index].id, index+2));
        //var dueDconvert = RubyDateToJS(dueD);
        var conv = RubyDateToJS(dueD);
        //alert("ruby conv: " + conv);
        //var dueDconvert = new Date(dueD);
        dueD = conv;
        //dueD = Date(dueD);
        //duDconvert = Date.(ueD));
        
        //alert("dueD: " + dueD + "   ||||   " + conv );
        var year = dueD.substr(0, 4);
        var month = dueD.substr(5, 2);
        var day = dueD.substr(8, 2);
        var date = month +"/"+day+"/"+year;
        
        var hour = dueD.substr(11,2);
        var minute= dueD.substr(14, 2);
        hour = parseInt(hour);
        var time;
        if (hour >0 && hour < 12) {
          time= hour+":"+minute +" a.m.";
        }
        else if(hour>12) {
          hour = hour-12;
          time= hour+":"+minute +" p.m.";
        }
        else{
          if (hour == 0) time= "12:"+minute +" a.m.";
          if (hour == 12) time= hour+":"+minute +" p.m.";
        }
        var numReminders;
        if(obj.bills[index].reminder1 == "" && obj.bills[index].reminder2 =="") numReminders=0;
        else if (obj.bills[index].reminder1 == "" || obj.bills[index].reminder2 =="")numReminders=1;
        else numReminders = 2;
        var category = obj.bills[index].category;
        var catLength = category.length;
        if(catLength == 3) category = "None selected";
        else {
          while(category.charAt(catLength-1) == ","){
            category = category.substring(0, catLength-1);
            catLength = category.length;
          }
          while(category.charAt(0) == ","){
            category = category.substring(1, catLength);
            catLength = category.length;
          }
        }
        var find = ",,";
        while(category.indexOf(find) != -1){
          var temp1 = category.substring(0, category.indexOf(find));
          var temp2 = category.substring(category.indexOf(find)+1, category.length);
          category = temp1 + temp2;
        }
        cell1.innerHTML = obj.bills[index].name;
        cell1.style.fontSize="110%";
        cell2.innerHTML = "$" +obj.bills[index].amountLo+"-$"+obj.bills[index].amountHi;
        cell2.style.fontSize="110%";
        cell3.innerHTML = date;
        cell3.style.fontSize="110%";
        cell3.style.textAlign = "center";
        cell4.innerHTML = time;
        cell4.style.fontSize="110%";
        cell4.style.textAlign = "center";
        cell5.innerHTML = category;
        cell5.style.fontSize="110%";
        var repeat = obj.bills[index].repeat;
        if(repeat != "Monthly" && repeat != "Weekly" && repeat != "Never" && repeat !="Biweekly"){
          repeat = repeat + " Months";
        }
        cell6.innerHTML = repeat + ":"+ numReminders +" reminder(s)";
        cell6.style.fontSize="110%";
        cell7.innerHTML = '<button style="width:60px;padding: 20px 0px 20px 0px;" onClick="editRow(this)" id="edit">Edit</button>'+" "+
          '<button style="width:85px;padding: 20px 0px 20px 0px;" onClick="deleteRow(this)">Delete</button>';
      } // end putbill
      
      function deleteOldPaid(){ // called by getBillsCallback, needs to be implemented with backend
        //obj = JSON.parse(getCookie("allBills"));
        obj = returnBills;
        //allBills = getCookie("allBills");
        allBills = JSON.stringify(returnBills); // justin thinks this is right 
        numBills = obj.bills.length;
        numPaid = 0;
        var inArray = 0;
        var date = Date();
        date = date.substring(4, 15);
        var month = date.substr(0, 3);
        var day = date.substr(4, 2);
        month = changeMonthToNumber(month);
        day = parseInt(day);
        var deleteArray = [];
        for  (var k=0; k < numBills; k++){
          if(obj.bills[k].dueDate.charAt(0) == ",") {
            var endDate = obj.bills[k].repeat.substr(5,6);
            var endMonth = changeMonthToNumber(endDate.substr(0, 3));
            var endDay = parseInt(endDate.substr(4, 2));
            if(day != endDay || month != endMonth) { //delete this paid bill
              deleteArray[inArray] = k;
              inArray++;
            }
            numPaid++;
          }
        }
        if(numPaid == 0 || inArray == 0) return;

        numBills = numBills - numPaid;
        var range;
        if (inArray == 1) range = [deleteArray[0], deleteArray[0]];
        else range =  [deleteArray[0], deleteArray[inArray-1]];
        var start = nth_occurrence(allBills, "{", range[0]+2);
        var end = nth_occurrence(allBills, "}", range[1]+1);
        start = allBills.substring(0, start);
        if (numBills == 0) end = allBills.substring(end+1, allBills.length);
        else end = allBills.substring(end+2, allBills.length);
        allBills = start + end;
        //setCookie("allBills", allBills, 30);
        return;
      } // end deleteOldPaid()
      
      var numPaid; //number of Paid bills // are these global? - justin
      var paidJson; // dictionaries for all Paid bills
      var editRowIndex;
      
      function updateBillsNoPaid() { //sets obj/numBills/allBills, needs implemented with returnbills
        //obj = JSON.parse(getCookie("allBills"));
        //alert("inside updateBillsNoPaid");
        obj = returnBills;
        //allBills = getCookie("allBills");
        allBills = JSON.stringify(returnBills);
        //alert("allBills inside updateBillsNoPaid: "+allBills);
        numBills = obj.bills.length;
        numPaid = 0;
        var temp = numBills;
        for  (var k=0; k < temp; k++){
          if(obj.bills[k].dueDate.charAt(0) == ",") {
            numBills--;
            numPaid++;
          }
          else {
            if (numPaid > 0) {
              paidJson = allBills.substring(nth_occurrence(allBills, "{", 2), nth_occurrence(allBills, "}", numPaid)+1);
            }
            else paidJson = "";
            if (numPaid > 0 && numBills > 0) {
              var firstPart = '{"bills":[';
              var secondPart = allBills.substring(nth_occurrence(allBills, "{", (2+numPaid)), allBills.length);
              allBills = firstPart + secondPart;
              obj = JSON.parse(allBills);
              return;
            }
            else if(numPaid > 0 && numBills == 0) {
              allBills = '{"bills":[]}';
              obj = JSON.parse(allBills);
              return;
            }
          }
        }
      } // end updateBillsNoPaid() ============================================================
      
      //needs implmented with returnbills
      function updateWithPaid(message) { // returns JSON array of bills, called by deleteRow(), updateJSON, saveEdit() as argument to setCookie 
        if (numPaid == 0) return message;
        else {
          var lastPart = message.substring(10, message.length);
          if (numBills > 0) return ('{"bills":['+paidJson+","+lastPart);
          else return ('{"bills":['+paidJson+']}');
        }
      }
      
      //returns the location of the nth occurrence of char in string
      function nth_occurrence (string, char, nth) {
        var first_index = string.indexOf(char);
        var length_up_to_first_index = first_index + 1;
        if (nth == 1) {
          return first_index;
        } 
        else {
          var string_after_first_occurrence = string.slice(length_up_to_first_index);
          var next_occurrence = nth_occurrence(string_after_first_occurrence, char, nth - 1);
          if (next_occurrence === -1) {
            return -1;
          } 
          else {
            return length_up_to_first_index + next_occurrence;  
          }
        }
      }
      
      //removes bills from table to be edited
      function editRow(o) { // called on click of bill edit button
        var p=o.parentNode.parentNode;
        editRowIndex = p.rowIndex;
        //alert("inside editRow: rowIndex: " + editRowIndex);
        p.parentNode.removeChild(p);
        updateBillsNoPaid();
        putInEditField();
      }
      
      var newJson; // global
      var oldJson; // global
      var changeBill = null;
      var changeIndex = -1;
      
      function putInEditField() { // displays fields for editing a bill, called by editRow
        //alert("inside putInEditField, editRowIndex: " + editRowIndex);
        var j;
        var table = document.getElementById("billTable");
        var name = null;
        var category = null;
        var paymentType = null;
        var loginPage = null;
        var dueDate = null;
        var repeat = null;
        var amountLo = null;
        var amountHi = null;
        var user_name = null;
        var reminder1 = null;
        var reminder2 = null;
        
        
        newJson = null;
        var find;
        for(j = 2; j < numBills+1; j++){
          name = obj.bills[j-2].name;
          //alert("name is: "+ name + " | j is: " + j);
          var row = table.rows[j].cells[0].firstChild.data;
          //alert("row is: " + row);
          if (name != row) {
            changeIndex = j-2; // justin added
            changeBill = obj.bills[j-2]; // justin added
            objOld = obj.bills[j-2];
            //alert("in putEditField changeBill: " + JSON.stringify(changeBill));
            name = obj.bills[j-2].name;
            category = obj.bills[j-2].category;
            paymentType = obj.bills[j-2].paymentType;
            loginPage = obj.bills[j-2].loginPage;
            dueDate = obj.bills[j-2].dueDate;
            //dueDate = new Date(dueDate + "UTC");
            //var dateObj = RubyDateToJS(dueDate);
            //var date2 = Date(dueDate);
            //var date3 = Date(dueDate + 'UTC');
            //alert("duedate: " + dueDate + " date2: " + date2 + " date3 " + date3);
            //dateUTC= Date.UTC(dueDate);
            //dueDate = RubyDateToJS(obj.bills[j-2].dueDate);
            //alert("not last bill dueDate : " + dueDate.toString() + " try dateUTC : " + dateUTC);
            repeat = obj.bills[j-2].repeat;
            amountLo = obj.bills[j-2].amountLo;
            amountHi = obj.bills[j-2].amountHi;
            user_name = obj.bills[j-2].user_name;
            reminder1 = obj.bills[j-2].reminder1;
            reminder2 = obj.bills[j-2].reminder2;
            
            //find = '{"name":"' +name;
            find = '"name":"' + name;
            //alert("find is : " + find + " | indexOf find is: " + allBills.indexOf(find)); // indexOf(find) is returning -1 bcause name is not first field
            var tempCookie = allBills.substring(0, allBills.indexOf(find)); // think this is supposed to be all bills up till the edited row
            
            //alert("tempCookie: " + tempCookie);
            //var find2 = '{"name":"' +row; // ask kyle
            var find2 = '"name":"' + row;
            //var find3 = ',{"name":"' +row; // ask kyle
            var find3 = '"name":"' + row; // same as find2 ok??
            //alert("find2: "+ find2 + " | find3: " + find3);
            
            oldJson = allBills.substring(allBills.indexOf(find), allBills.indexOf(find3)); 
            //alert("oldjson in putInEditField: " + oldJson);
            newJson = allBills.substring(allBills.indexOf(find2), allBills.length);
            
            newJson = tempCookie + newJson;
            //alert("newjson in putInEditField: " + newJson);
            break;
          }
        }
        if(newJson == null) { //editing last  & there is more than 1 bill
          changeIndex = numBills-1; // justin added
          changeBill = obj.bills[numBills-1]; // justin added
          objOld = obj.bills[numBills-1];
          name = obj.bills[(numBills-1)].name;
          //alert("new json was null, name : " + name);
          category = obj.bills[(numBills-1)].category;
          paymentType = obj.bills[(numBills-1)].paymentType;
          loginPage = obj.bills[(numBills-1)].loginPage;
          dueDate = obj.bills[(numBills-1)].dueDate;
          //dueDate = new Date(dueDate + "UTC");
          //alert("due date after convert :" + dueDate );
          //dueDate = RubyDateToJS(obj.bills[numBills-1].dueDate);
          //alert("new json was null, duddate : " + dueDate.toString() + " try getHours : " + dueDate.getHours());
          repeat = obj.bills[(numBills-1)].repeat;
          amountLo = obj.bills[(numBills-1)].amountLo;
          amountHi = obj.bills[(numBills-1)].amountHi;
          user_name = obj.bills[(numBills-1)].user_name;
          reminder1 = obj.bills[(numBills-1)].reminder1;
          reminder2 = obj.bills[(numBills-1)].reminder2;
          if(numBills == 1) find = '"name":"' +name;
          else find = ',"name":"' +name;
          newJson = allBills.substring(0, allBills.indexOf(find))+"]}";
          if(numBills != 1) find = find.substring(1, find.length);
          oldJson = allBills.substring(allBills.indexOf(find),  allBills.indexOf("]}"));
        }
        var NM = JSON.parse(getCookie("NM"));
        var numMethods = NM.methods.length;
        methods = ["", "", "", ""];
        for (var i = 0; i < numMethods; i++) {
          if(NM.methods[i].verified == "verified") {
            methods[i] = NM.methods[i].name;
          }
        }
        
       
        $('#addBill').css('visibility','hidden');
        //testGet2();
        $('#billTable').find('tbody').append($('<tr id="editBill">')
        .append($('<td><input type="text" placeholder="bill name" id="billname" value="'+name+'" required /></td>'))
        .append($('<td><div class="left"><div class="left"><label>$</label></div><div class="left">'+
        '<input type="text" placeholder="low" id="amountLo" value="'+amountLo+'" style="width:60px;" /></div><div class="clear"></div></div>-'+
        '<div class="right"><input type="text" placeholder="high" id="amountHi" value="'+amountHi+'"style="width:60px;" /></div><div class="clear"></td>'))
        .append($('<td><select id="month" style="width:69px;"><option value="01">Jan</option>'+
          '<option value="02">Feb</option><option value="03">Mar</option><option value="04">Apr</option>'+
          '<option value="05">May</option><option value="06">Jun</option><option value="07">Jul</option>'+
          '<option value="08">Aug</option><option value="09">Sep</option><option value="10">Oct</option>'+
          '<option value="11">Nov</option><option value="12">Dec</option></select>'+
          '<select id="day" style="width:58px;"><option value="01">01</option>'+
          '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
          '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
          '<option value="08">08</option><option value="09">09</option><option value="10">10</option>'+
          '<option value="11">11</option><option value="12">12</option><option value="13">13</option>'+
          '<option value="14">14</option><option value="15">15</option><option value="16">16</option>'+
          '<option value="17">17</option><option value="18">18</option><option value="19">19</option>'+
          '<option value="20">20</option><option value="21">21</option><option value="22">22</option>'+
          '<option value="23">23</option><option value="24">24</option><option value="25">25</option>'+
          '<option value="26">26</option><option value="27">27</option><option value="28">28</option>'+
          '<option value="29">29</option><option value="30">30</option><option value="31">31</option></select>'+
          '<select id="year" style="width:74px;"><option value="2015">2015</option>'+
          '<option value="2016">2016</option><option value="2017">2017</option></select></td>'))
        .append($('<td><select id="hour" style="width:58px;"><option value="01">01</option>'+
          '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
          '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
          '<option value="08">08</option><option value="09">09</option><option value="10">10</option>'+
          '<option value="11">11</option><option value="12">12</option></select>'+
          '<select id="minute" style="width:59px;"><option value="00">00</option>'+
          '<option value="05">05</option><option value="10">10</option><option value="15">15</option>'+
          '<option value="20">20</option><option value="25">25</option><option value="30">30</option>'+
          '<option value="35">35</option><option value="40">40</option><option value="45">45</option>'+
          '<option value="50">50</option><option value="55">55</option></select>'+
          '<select id="ampm" style="width:63px;"><option value="am">am</option>'+
          '<option value="pm">pm</option></select></td>'))
        .append($('<td><div class = "left"><input id="method1" type="checkbox"/><label id="label1">'+methods[0]+'</label></div>'+
        '<div class = "right"><input id="method2" type="checkbox"/><label id="label2">'+methods[1]+'</label></div><div class="clear"></div>'+
        '<div class = "left"><input id="method3" type="checkbox"/><label id="label3">'+methods[2]+'</label></div>'+
        '<div class = "right"><input id="method4" type="checkbox"/><label id="label4">'+methods[3]+'</label></div><div class = "clear"></div></td>'))
       .append($('<td><div class="left"><input type="radio" id="never" name="rep" checked><label for="never">Never</label></div>'+
        '<div class="right"><input type="radio" id="weekly" name="rep"><label for="weekly">Weekly</label></div><div class ="clear"></div>'+
        '<div class="left"><input type="radio" id="monthly" name="rep"><label for="monthly">Monthly</label></div>'+
        '<div class="right"><input type="radio" id="biweekly" name="rep"><label for="biweekly">Biweekly</label></div><div class ="clear"></div></td>'))
        .append($('<td><div class="left"><div class="left"><input type="radio" style="margin:auto;" id="custom" name="rep" ></div>'+
        '<div class="left"><input style="width:60px;margin:auto;" type="text" placeholder="(1-12)" id="customInput"/>'+
        '</div><div class="clear"></div></div><div class="left"><label>months</label></div><div class="clear"></div></td></tr>'))
        );
        $('#billTable tr:last').after($('<tr id="extraRow"><td></td><td><b>Reminders:<br/>Sends reminder before bill due date</b></td>'+
        '<td><div class = "left"><label>(#1) Days +</label><select id="reminder1days" style="width:80px;">'+
        '<option value="00">00</option><option value="01">01</option>'+
        '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
        '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
        '<option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option>'+
        '<option value="12">12</option><option value="13">13</option><option value="14">14</option></select></div>'+
        '<div class = "left"><label>Hours before</label><select id="reminder1hours" style="width:80px;">'+
        '<option value="00">00</option><option value="01">01</option>'+
        '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
        '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
        '<option value="08">08</option><option value="09">09</option><option value="10">10</option>'+
        '<option value="11">11</option><option value="12">12</option><option value="13">13</option>'+
        '<option value="14">14</option><option value="15">15</option><option value="16">16</option>'+
        '<option value="17">17</option><option value="18">18</option><option value="19">19</option>'+
        '<option value="20">20</option><option value="21">21</option><option value="22">22</option>'+
        '<option value="23">23</option></select></div><div class = "clear"></div>'+
        '</td><td><div class = "left"><label>(#2) Days +</label><select id="reminder2days" style="width:80px;">'+
        '<option value="00">00</option><option value="01">01</option>'+
        '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
        '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
        '<option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option>'+
        '<option value="12">12</option><option value="13">13</option><option value="14">14</option></select></div>'+
        '<div class = "left"><label>Hours before</label><select id="reminder2hours" style="width:80px;">'+
        '<option value="00">00</option><option value="01">01</option>'+
        '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
        '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
        '<option value="08">08</option><option value="09">09</option><option value="10">10</option>'+
        '<option value="11">11</option><option value="12">12</option><option value="13">13</option>'+
        '<option value="14">14</option><option value="15">15</option><option value="16">16</option>'+
        '<option value="17">17</option><option value="18">18</option><option value="19">19</option>'+
        '<option value="20">20</option><option value="21">21</option><option value="22">22</option>'+
        '<option value="23">23</option></select></div><div class = "clear"></div></td>'+
        '<td><label>Payment Process</label><select id="paymentType" style="width:100px;"><option value="">Select</option>'+
          '<option value="in person">In person</option><option value="online">Online</option>'+
          '<option value="by phone">By phone</option><option value="autopay">Autopay</option></select></td><td>'+
        '<input type="text" placeholder="URL/Phone# to pay bill" id="url" value ="'+loginPage+'" /></td></tr>'));
        var posCom;
        find = ",";
        if(category.charAt(0) != ",") {
          posCom = category.indexOf(find);
          document.getElementById("method1").checked = true;
          category=category.substring(posCom+1, category.length);
        }
        else{
          category = category.substring(1, category.length);
        }
        if(category.charAt(0) != ",") {
          posCom = category.indexOf(find);
          document.getElementById("method2").checked = true;
          category=category.substring(posCom+1, category.length);
        }
        else{
          category = category.substring(1, category.length);
        }
        if(category.charAt(0) != ",") {
          posCom = category.indexOf(find);
          document.getElementById("method3").checked = true;
          category=category.substring(posCom+1, category.length);
        }
        else{
          category = category.substring(1, category.length);
        }
        if(category.length != 0) document.getElementById("method4").checked = true;
        
        var year = dueDate.substr(0, 4);
        var month = dueDate.substr(5, 2);
        var day = dueDate.substr(8, 2);
        var hour = dueDate.substr(11, 2);
        var minute = dueDate.substr(14, 2);
        var ampm;
        //alert("year: " +year + " month : " + month + " day: " + day);
        var reminderArray1 = ["",""];
        var reminderArray2 = ["",""];
        //alert("reminder 1 " + JSON.stringify(reminder1) + " reminder2: " + JSON.stringify(reminder2) + "should be: " + getDateTime(1983,1,1,0,0,"0000",0,0));
        if (reminder1 != getDateTime(1983,1,1,0,0,"0000",0,0) ) {
          //alert("in if for reminder 1");
          reminderArray1 = reverse(year, month, day, hour, reminder1);
          if(reminderArray1[0] == "" || reminderArray1[0] == "0") {
            reminderArray1[0] = "00";
          }
          if(reminderArray1[1] == "" || reminderArray1[1] == "0") {
            reminderArray1[1] = "00";
          }
          document.getElementById("reminder1days").value = reminderArray1[0];
          document.getElementById("reminder1hours").value = reminderArray1[1];
        } 
        
        if (reminder2 != getDateTime(1983,1,1,0,0,"0000",0,0)) {
          reminderArray2 = reverse(year, month, day, hour, reminder2);
          //alert("wont get here");
          if(reminderArray2[0] == "" || reminderArray2[0] == "0") {
            reminderArray2[0] = "00";
          }
          if(reminderArray2[1] == "" || reminderArray2[1] == "0") {
            reminderArray2[1] = "00";
          }
          document.getElementById("reminder2days").value = reminderArray2[0];
          document.getElementById("reminder2hours").value = reminderArray2[1];
        }
        
        hour = parseInt(hour);
        if (hour >12) {
          hour = hour-12;
          ampm = "pm";
        }        
        else if (hour == 0){
          hour = 12;
          ampm = "am";
        }
        else if (hour == 12) ampm = "pm";
        else ampm = "am";
        if (hour < 10) hour = "0"+hour;
        //alert("year: " +year + " month : " + month + " day: " + day);
        document.getElementById("month").value = month;
        document.getElementById("year").value = year;
        document.getElementById("day").value = day;
        document.getElementById("hour").value = hour;
        document.getElementById("minute").value = minute;
        document.getElementById("ampm").value = ampm;
        document.getElementById("paymentType").value = paymentType;
        
        var numHidden = 0;
        if(methods[3] == "") {
          $('#method4').css('visibility','hidden');
          $('#label4').css('visibility','hidden');
          numHidden++;
        }
        if(methods[2] == "") {
          $('#method3').css('visibility','hidden');
          $('#label3').css('visibility','hidden');
          numHidden++;
        }
        if(methods[1] == "") {
          $('#method2').css('visibility','hidden');
          $('#label2').css('visibility','hidden');
          numHidden++;
        }
        if(methods[0] == "") {
          $('#method1').css('visibility','hidden');
          $('#label1').css('visibility','hidden');
          numHidden++;
        }
        
        if(numHidden == 4) {
          alert("Until you have at least ONE verified email or phone notification"+
          " method, you will be unable to select notification methods for any bill."+
          " This also means that you will also be unable to receive any notifications!"+
          " They will appear area noted 'PLEASE VERIFY YOUR NOTIFICATION METHODS ASAP!' one you verify them! Thanks!");
          $('#label1').css('visibility','visible');
          document.getElementById("label1").innerHTML = "PLEASE VERIFY YOUR <br/>NOTIFICATION METHODS ASAP!".bold();
        }
        
        if(repeat == "Never") document.getElementById("never").checked = true;
        else if(repeat == "Weekly") document.getElementById("weekly").checked = true;
        else if(repeat == "Monthly") document.getElementById("monthly").checked = true;
        else if(repeat == "Biweekly") document.getElementById("biweekly").checked = true;
        else {
          document.getElementById("customInput").value = repeat;
          document.getElementById("custom").checked = true;
        }
        $('#saveEdit').css('visibility','visible');
        $('#cancelEdit').css('visibility','visible');
        var myTable = document.getElementById("billTable");
        for(i = 2; i < numBills+1; i++){
          myTable.rows[i].cells[6].innerHTML = '<button style="width:60px;padding: 20px 0px 20px 0px;" onClick="youCant()">'+
          'Edit</button> <button style="width:85px;padding: 20px 0px 20px 0px;" onClick="youCant()">Delete</button>';
        }
      } // end putInEditField =======================================================
      
      function youCant(){
        alert("You cannot edit/delete another bill while one is currently being added or edited");
      }
      
      //removes from table and calles updateJson to remove completely from backend, needs work
      function deleteRow(o){ // called when Delete button of bill is clicked
        if (confirm("Are you sure?  Deleting this bill cannot be undone!") == true){
        var p=o.parentNode.parentNode;
        p.parentNode.removeChild(p);
        updateBillsNoPaid();
        if(numBills == 1) {
          numBills = 0;
          // insert DELETE here
          //setCookie("allBills",updateWithPaid('{"bills":[]}'),30);
          //return;
          
        }
        updateJson();
        //return;
        deleteBillHTTP(deleteId).done(deleteBillCallback);
        //window.location.reload();
        } else {
          window.location.reload();
        }
        
      } // end deleteRow ====================================
      
      function updateJson(){ // called by deleteRow
        var j;
        var table = document.getElementById("billTable");
        //updateBillsNoPaid();
        var total;
        for(j = 2; j < numBills+1; j++){
          var name = obj.bills[j-2].name;
          total = '"name":"'+name;
          var row = '"name":"'+table.rows[j].cells[0].firstChild.data;
          if (total != row) {
            var tempCookie = allBills.substring(0, allBills.indexOf(total));
            var tempCookie2 = allBills.substring(allBills.indexOf(row), allBills.length);
            addNL("You deleted your "+name+ " bill!", "delete bill");
            tempCookie2 = tempCookie + tempCookie2;
            setCookie("allBills", updateWithPaid(tempCookie2), 30);
            numBills--;
            return;
          }
        }
        name = obj.bills[(numBills-1)].name;
        total = ',{"name":"'+name;
        tempCookie = allBills.substring(0, allBills.indexOf(total))+"]}";
        addNL("You deleted your "+name+ " bill!", "delete bill");
        setCookie("allBills", updateWithPaid(tempCookie), 30);
        numBills--;
        return;
      } // end update Json ====================================================
      
      function Log(info, date, time, eventType, user_name) {
        this.info = info;
        this.date = date;
        this.time = time;
        this.eventType = eventType;
        this.user_name = user_name;
      }
      
      //creates a log item given a message and eventType
      function addNL(message, eventType){
        var currDate = Date();
        var currTime = currDate.substring(16, 24);
        var currHours = parseInt(currTime.substr(0, 2));
        var ampm;
        if (currHours >=1 && currHours <= 12){
          ampm = " a.m.";
        }
        else if (currHours >= 13){
          currHours = currHours -12;
          ampm = " p.m.";
        }
        else {
          currHours = 1;
          ampm = " a.m.";
        }
        currTime = currHours + currTime.substr(2, 3) + ampm;
        currDate = currDate.substring(4, 15);
        var currUser = JSON.parse(getCookie("currUser"));
        var user_name = currUser.username;
        var newLog = new Log(message, currDate, currTime, eventType, user_name);
        var stringy = JSON.stringify(newLog);
        var NL = JSON.parse(getCookie("NL"));
        var numLogs = NL.logs.length;
        NL=getCookie("NL");
        var temp = NL.substring(0, NL.length - 2);
        if (numLogs == 0) {
          NL = temp + stringy + "]}";
        }
        else{
          NL = temp + "," + stringy + "]}";
        }
        //setCookie("NL",NL,30);
        //alert("going to call addLogHTTP with stringy: " + stringy);
        addLogHTTP(stringy).done(addLogCallback);
      }
      
      function testGet(){
        $.getJSON('https://pdit-backend-jcskillings.c9.io/users/22.json', function( data ){
          var items = [];
          //alert(JSON.parse(data));
          $.each( data, function( key, val ) {
          items.push( "<li id='" + key + "'>" + val + "</li>" );
          });
 
          $( "<ul/>", {
            "class": "my-new-list",
            html: items.join( "" )
          }).appendTo( "body" );
          });
      }
      
      function testGet2(){
        $.getJSON('https://pdit-backend-jcskillings.c9.io/users/22', null, function(data){
          //alert('did this work???');
          //alert(JSON.parse(data));
        });
        
      }
        
      // Gets a cookie by name
      function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) {
              return c.substring(name.length, c.length);
            }
          }
        return "";
      }
      
      // Bill object constructor
      function Bill(name, category, paymentType, loginPage, dueDate, repeat, amountLo, amountHi, user_id, user_name, reminder1, reminder2){
        this.name = name;
        this.category = category;
        this.paymentType = paymentType;
        this.loginPage = loginPage;
        this.dueDate = dueDate;
        this.repeat= repeat;
        this.amountLo = amountLo;
        this.amountHi = amountHi;
        this.user_id = user_id;
        this.user_name = user_name;
        this.reminder1 = reminder1;
        this.reminder2 = reminder2;
        
      } 
      
      
      var methods; // global
      //============================
      $('#addBill').click(function(){ // called when add bill button is clicked
        $('#addBill').css('visibility','hidden');
        var NM = JSON.parse(getCookie("NM"));
        var numMethods = NM.methods.length;
        methods = ["", "", "", ""];
        for (var i = 0; i < numMethods; i++) {
          if(NM.methods[i].verified == "verified") {
            methods[i] = NM.methods[i].name;
          }
        }
        $('#billTable').find('tbody').append($('<tr id="createBill">')
        .append($('<td><input type="text" placeholder="bill name" id="billname" required /></td>'))
        .append($('<td><div class="left"><div class="left"></div><div class="left">'+
        '<input type="text" placeholder="low" id="amountLo" style="width:60px;" /></div><div class="clear"></div></div>-'+
        '<div class="right"><input type="text" placeholder="high" id="amountHi" style="width:60px;" /></div><div class="clear"></td>'))
        .append($('<td><select id="month" style="width:64px;"><option value="01">Jan</option>'+
          '<option value="02">Feb</option><option value="03">Mar</option><option value="04">Apr</option>'+
          '<option value="05">May</option><option value="06">Jun</option><option value="07">Jul</option>'+
          '<option value="08">Aug</option><option value="09">Sep</option><option value="10">Oct</option>'+
          '<option value="11">Nov</option><option value="12">Dec</option></select>'+
          '<select id="day" style="width:56px;"><option value="01">01</option>'+
          '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
          '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
          '<option value="08">08</option><option value="09">09</option><option value="10">10</option>'+
          '<option value="11">11</option><option value="12">12</option><option value="13">13</option>'+
          '<option value="14">14</option><option value="15">15</option><option value="16">16</option>'+
          '<option value="17">17</option><option value="18">18</option><option value="19">19</option>'+
          '<option value="20">20</option><option value="21">21</option><option value="22">22</option>'+
          '<option value="23">23</option><option value="24">24</option><option value="25">25</option>'+
          '<option value="26">26</option><option value="27">27</option><option value="28">28</option>'+
          '<option value="29">29</option><option value="30">30</option><option value="31">31</option></select>'+
          '<select id="year" style="width:74px;"><option value="2015">2015</option>'+
          '<option value="2016">2016</option><option value="2017">2017</option></select></td>'))
        .append($('<td><select id="hour" style="width:58px;"><option value="01">01</option>'+
          '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
          '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
          '<option value="08">08</option><option value="09">09</option><option value="10">10</option>'+
          '<option value="11">11</option><option value="12">12</option></select>'+
          '<select id="minute" style="width:59px;"><option value="00">00</option>'+
          '<option value="05">05</option><option value="10">10</option><option value="15">15</option>'+
          '<option value="20">20</option><option value="25">25</option><option value="30">30</option>'+
          '<option value="35">35</option><option value="40">40</option><option value="45">45</option>'+
          '<option value="50">50</option><option value="55">55</option></select>'+
          '<select id="ampm" style="width:63px;"><option value="am">am</option>'+
          '<option value="pm">pm</option></select></td>'))
        .append($('<td><div class = "left"><input id="method1" type="checkbox"/><label id="label1">'+methods[0]+'</label></div>'+
        '<div class = "right"><input id="method2" type="checkbox"/><label id="label2">'+methods[1]+'</label></div><div class="clear"></div>'+
        '<div class = "left"><input id="method3" type="checkbox"/><label id="label3">'+methods[2]+'</label></div>'+
        '<div class = "right"><input id="method4" type="checkbox"/><label id="label4">'+methods[3]+'</label></div><div class = "clear"></div></td>'))
        .append($('<td><div class="left"><input type="radio" id="never" name="rep" checked><label for="never">Never</label></div>'+
        '<div class="right"><input type="radio" id="weekly" name="rep"><label for="weekly">Weekly</label></div><div class ="clear"></div>'+
        '<div class="left"><input type="radio" id="monthly" name="rep"><label for="monthly">Monthly</label></div>'+
        '<div class="right"><input type="radio" id="biweekly" name="rep"><label for="biweekly">Biweekly</label></div><div class ="clear"></div></td>'))
        .append($('<td><div class="left"><div class="left"><input type="radio" style="margin:auto;" id="custom" name="rep" ></div>'+
        '<div class="left"><input style="width:60px;margin:auto;" type="text" placeholder="(1-12)" id="customInput"/>'+
        '</div><div class="clear"></div></div><div class="left"><label>months</label></div><div class="clear"></div></td></tr>'))
        );
        $('#billTable tr:last').after($('<tr id="extraRow"><td></td><td><b>Reminders:<br/>Sends reminder before bill due date</b></td>'+
        '<td><div class = "left"><label>(#1) Days +</label><select id="reminder1days" style="width:80px;">'+
        '<option value="00">00</option><option value="01">01</option>'+
        '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
        '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
        '<option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option>'+
        '<option value="12">12</option><option value="13">13</option><option value="14">14</option></select></div>'+
        '<div class = "left"><label>Hours before</label><select id="reminder1hours" style="width:80px;">'+
        '<option value="00">00</option><option value="01">01</option>'+
        '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
        '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
        '<option value="08">08</option><option value="09">09</option><option value="10">10</option>'+
        '<option value="11">11</option><option value="12">12</option><option value="13">13</option>'+
        '<option value="14">14</option><option value="15">15</option><option value="16">16</option>'+
        '<option value="17">17</option><option value="18">18</option><option value="19">19</option>'+
        '<option value="20">20</option><option value="21">21</option><option value="22">22</option>'+
        '<option value="23">23</option></select></div><div class = "clear"></div>'+
        '</td><td><div class = "left"><label>(#2) Days +</label><select id="reminder2days" style="width:80px;">'+
        '<option value="00">00</option><option value="01">01</option>'+
        '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
        '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
        '<option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option>'+
        '<option value="12">12</option><option value="13">13</option><option value="14">14</option></select></div>'+
        '<div class = "left"><label>Hours before</label><select id="reminder2hours" style="width:80px;">'+
        '<option value="00">00</option><option value="01">01</option>'+
        '<option value="02">02</option><option value="03">03</option><option value="04">04</option>'+
        '<option value="05">05</option><option value="06">06</option><option value="07">07</option>'+
        '<option value="08">08</option><option value="09">09</option><option value="10">10</option>'+
        '<option value="11">11</option><option value="12">12</option><option value="13">13</option>'+
        '<option value="14">14</option><option value="15">15</option><option value="16">16</option>'+
        '<option value="17">17</option><option value="18">18</option><option value="19">19</option>'+
        '<option value="20">20</option><option value="21">21</option><option value="22">22</option>'+
        '<option value="23">23</option></select></div><div class = "clear"></div></td>'+
        '<td><label>Payment Process</label><select id="paymentType" style="width:100px;"><option value="">Select</option>'+
          '<option value="in person">In person</option><option value="online">Online</option>'+
          '<option value="by phone">By phone</option><option value="autopay">Autopay</option></select></td><td>'+
        '<input type="text" placeholder="URL/Phone# to pay bill" id="url"  /></td></tr>'));
        
        //set default due date/time
        var d = new Date();
        $('#hour').val("05");
        $('#minute').val("00");
        $('#ampm').val("pm");
        $('#month').val(MonthNumToVal(d.getMonth()));
        $('#day').val(d.getDate());
        //alert("day: " + d.getDate() + " month: "+ MonthNumToVal(d.getMonth()) + " year: " + d.getFullYear());
        $('#year').val(d.getFullYear());
        
        //set default reminder times
        $('#reminder1days').val("02");
        $('#reminder1hours').val("00");
        $('#reminder2days').val("00");
        $('#reminder2hours').val("02");
        $('#paymentType').val("online");
        document.getElementById("monthly").checked = true;
        //$('#monthly').val(true);
        var numHidden = 0;
        if(methods[3] == "") {
          $('#method4').css('visibility','hidden');
          $('#label4').css('visibility','hidden');
          numHidden++;
        }
        if(methods[2] == "") {
          $('#method3').css('visibility','hidden');
          $('#label3').css('visibility','hidden');
          numHidden++;
        }
        if(methods[1] == "") {
          $('#method2').css('visibility','hidden');
          $('#label2').css('visibility','hidden');
          numHidden++;
        }
        if(methods[0] == "") {
          $('#method1').css('visibility','hidden');
          $('#label1').css('visibility','hidden');
          numHidden++;
        }
        if(numHidden == 4) {
          alert("Until you have at least ONE verified email or phone notification"+
          " method, you will be unable to select notification methods for any bill."+
          " This also means that you will also be unable to receive any notifications!"+
          " They will appear area noted 'PLEASE VERIFY YOUR NOTIFICATION METHODS ASAP!' once you verify them! Thanks!");
          $('#label1').css('visibility','visible');
          document.getElementById("label1").innerHTML = "PLEASE VERIFY YOUR <br/>NOTIFICATION METHODS ASAP!".bold();
        }
        $('#saveBtn').css('visibility','visible');
        $('#cancelBtn').css('visibility','visible');
        var myTable = document.getElementById("billTable");
        for(i = 2; i < numBills+2; i++){
          myTable.rows[i].cells[6].innerHTML = '<button style="width:60px;padding: 20px 0px 20px 0px;" onClick="youCant()">Edit</button>'+" "+
          '<button style="width:85px;padding: 20px 0px 20px 0px;" onClick="youCant()">Delete</button>';
        }
      }); // end add bill ======================================================================================================
      
      
      $('table').on('click', '.delete', function(){
        $(this).closest('tr').remove();
      });
      
      $('#cancelBtn').click( function() {
          $('#createBill').remove();
          $('#extraRow').remove();
          $('#saveBtn').css('visibility','hidden');
          $('#cancelBtn').css('visibility','hidden');
          $('#addBill').css('visibility','visible');
          window.location.reload();
      });
      
      $('#cancelEdit').click( function() {
          $('#createBill').remove();
          $('#extraRow').remove();
          $('#saveEdit').css('visibility','hidden');
          $('#cancelEdit').css('visibility','hidden');
          $('#addBill').css('visibility','visible');
          window.location.reload();
      });
      //=============================================================
      $('#saveEdit').click( function() { // called on click of saveEdit button (save button visible when editing bill)
        //alert("entereing saveEdit oldJson: " + JSON.stringify(oldJson) + " changeBill:" + JSON.stringify(changeBill));
        $('#saveEdit').css('visibility','hidden');
        updateBillsNoPaid(); 
        //alert("returned in saveEdit.click from updateBillsNoPaid");
        
        var name = document.getElementById("billname").value;
  
        var year = document.getElementById("year").value;
        var month = document.getElementById("month").value;
        var day = document.getElementById("day").value;
        
        var valid = checkValidDate(year, month, day);
        if(valid == false) {
          alert("You have entered an invalid day for the selected month");
          return;
        }
        var date = year +"-"+ month+"-"+day;
          
        var ampm = document.getElementById("ampm").value;
        var hour = document.getElementById("hour").value;
        //alert("hour is: "+ hour);
        var minute = document.getElementById("minute").value;
        if (minute == null) {
          alert("minute is null: "+ minute);
        }
        var time;
        if(ampm == "am" && hour != "12") {
          time = hour + ":" + minute + ":00";
        }
        else if (ampm == "pm" && hour != "12") {
          hour = parseInt(hour) + 12;
          time = hour + ":" + minute + ":00";
        }
        else {
          if(ampm == "am") time = "00:" + minute + ":00";
          else time = "12:" + minute + ":00";
        }
        oldJson = changeBill;
        //alert("in saveEdit | oldJson:" + JSON.stringify(oldJson) ); // oldJson was originally set in putInEditField
        //oldJson = JSON.parse(oldJson); 
        
        //alert("passed oldJson parse");
        var currTZ = oldJson.dueDate;
        currTZ = currTZ.substr(currTZ.length - 4, 4);
        var dueDate = date + " "+ time +" +"+currTZ;

        var method1 = document.getElementById("method1").checked;
        var method2 = document.getElementById("method2").checked;
        var method3 = document.getElementById("method3").checked;
        var method4 = document.getElementById("method4").checked;
        
        var notifs = "";
        if (method1 == true) notifs = methods[0] +",";
        else notifs = ",";
        if (method2 == true) notifs = notifs + methods[1] +",";
        else notifs = notifs +",";
        if (method3 == true) notifs = notifs + methods[2] +",";
        else notifs = notifs + ",";
        if (method4 == true) notifs = notifs + methods[3];
       
        
        var category = notifs;
        var loginPage = document.getElementById("url").value;
        
        var repeat;
        if(document.getElementById("never").checked == true) repeat = "Never";
        else if(document.getElementById("weekly").checked == true) repeat = "Weekly";
        else if(document.getElementById("monthly").checked == true) repeat = "Monthly";
        else if(document.getElementById("biweekly").checked == true) repeat = "Biweekly";
        else {
          var r = parseInt(document.getElementById("customInput").value);
          if (r==1||r==2||r==3||r==4||r==5||r==6||r==7||r==8||r==9||r==10||r==11||r==12) repeat = r;
          else repeat = "Never";
        }

        var amountLo = document.getElementById("amountLo").value;
        //alert("new ammount lo:" + amountLo);
        var amountHi = document.getElementById("amountHi").value;
        
        if(amountLo == null || amountLo == ""){
          amountLo = amountHi;
        }
        if(amountHi == null || amountHi == "") {
          amountHi = amountLo;
        }
        
        var currUser = JSON.parse(getCookie("currUser"));
        var user_name = currUser.username; // changed from userName
        var reminder1days = document.getElementById("reminder1days").value;
        var reminder1hours = document.getElementById("reminder1hours").value;
        var reminder2days = document.getElementById("reminder2days").value;
        var reminder2hours = document.getElementById("reminder2hours").value;
        var reminder1;
        var reminder2;
        if(reminder1days == "00" && reminder1hours == "00") {
          reminder1 = getDateTime(1983,1,1,0,0,"0000",0,0);
        }
        else reminder1 = getDateTime(year, month, day, hour, minute, currTZ, reminder1days, reminder1hours);
        if(reminder2days == "00" && reminder2hours == "00") {
          reminder2 = getDateTime(1983,1,1,0,0,"0000",0,0);
        }
        else reminder2 = getDateTime(year, month, day, hour, minute, currTZ, reminder2days, reminder2hours);
        var paymentType = document.getElementById("paymentType").value;
        var user_id = currUser.id;
        var newBill = new Bill(name, category, paymentType, loginPage, dueDate, repeat, amountLo, amountHi, user_id, user_name, reminder1, reminder2);
        var stringy = JSON.stringify(newBill); // stringy is the newly edited bill JSON
        //allBills = newJson;
        //alert("stringy inside SaveEdit: " + stringy);
        oldJson = objOld;
        var tempBills = newJson.substring(0, newJson.length - 2);
        if (numBills == 1){
          tempBills = '{"bills":[' + stringy + "]}";
        }
        else {
          tempBills = tempBills + "," + stringy + "]}";
        }
        var numEdited = 0;
        
        mes = "You edited your " + oldJson.name + "bill to have a new:";
        if(oldJson.name != name) {
          mes= mes+"name("+name+")";
          numEdited++;
        }
        if(oldJson.category != category){
          if(numEdited == 0) {
            mes= mes+"active notification method(s)";
            numEdited++;
          }
          else mes= mes+", active notification methods";
        }
        if(oldJson.paymentType != paymentType){
          if(numEdited == 0) {
            mes= mes+"way you pay your "+name;
            numEdited++;
          }
          else mes= mes+", way you pay your "+name;
        }
        if(oldJson.loginPage != loginPage){
          if(numEdited == 0) {
            mes= mes+"link/phone# to pay your "+name;
            numEdited++;
          }
          else mes= mes+", link/phone# to pay your "+name;
        }
        //alert("OLDJSON DUEDATE ====" + oldJson.duedate);
        if(oldJson.dueDate != dueDate){
          
          if(numEdited == 0) {
            mes= mes+"due date(" +dueDate+")";
            numEdited++;
          }
          else mes= mes+", due date("+dueDate+")";
        }
        if(oldJson.repeat != repeat){
          if(numEdited == 0) {
            mes= mes+"pay frequency("+repeat+")";
            numEdited++;
          }
          else mes= mes+", pay frequency("+repeat+")";
        }
        if(oldJson.amountLo != amountLo || oldJson.amountHi != amountHi){
          if(numEdited == 0) {
            mes= mes+"amount("+amountLo+","+amountHi+")";
            numEdited++;
          }
          else mes= mes+", amount("+amountLo+","+amountHi+")";
        }
        if(oldJson.reminder1 != reminder1){
          if(numEdited == 0) {
            mes= mes+"reminder #1";
            numEdited++;
          }
          else mes= mes+", reminder #1";
        }
        if(oldJson.reminder2 != reminder2){
          if(numEdited == 0) {
            mes= mes+"reminder #2";
            numEdited++;
          }
          else mes= mes+", reminder #2";
        }
        mes= mes+"!";
        //addNL(mes, "edit bill");
        //setCookie("allBills",updateWithPaid(tempBills),30);
        $('#addBill').css('visibility','visible');
        //alert("calling putBillHTTP for bill id: " + oldJson.id + " oldJson = " + JSON.stringify(oldJson));
        //alert("calling putBillHTTP with newBill= " + JSON.stringify(newBill));
        var putBillString = JSON.stringify(newBill);
        // call put bill and call addLog inside, call reload from addLog
        putBillHTTP(putBillString, oldJson.id).done(putBillCallback);
        //window.location.reload();
      }); // end saveEdit =======================================================================
      
      function putBillHTTP(editedBill, billId){ // need correctly formated bill json and bill id
        return $.ajax({
          type: "PUT",
          dataType: 'json',
          //url: 'https://pdit-backend-jcskillings.c9.io/bills/'+billId+'.json',
          url: backendURL+'bills/'+billId+'.json',
          data: editedBill,
          contentType: 'application/json'
          //success: function(data){
          //  alert("PUT return: "+ JSON.stringify(data));
          //}
        
          });
        
      }
      
      function putBillCallback(data){ // everything that needs to be done after a bill is edited
        //alert("putbill callback data: " + JSON.stringify(data));
        
        // will need to add log item
        addNL(mes, "edit bill");
      }
      
      function addBillHTTP(newBillJson){
        return $.ajax({
          type: "POST",
          dataType: 'json',
          //url: 'https://pdit-backend-jcskillings.c9.io/bills.json',
          url: backendURL+'bills.json',
          data: newBillJson,
          contentType: 'application/json'
          //success: function(data){
          //  alert("PUT return: "+ JSON.stringify(data));
          //}
        
          });
      }
      
      function addBillCallback(data){ // everything that needs to be done after a new bill is added
        //alert("addBill callback data: " + JSON.stringify(data));
      }
      
      function addLogHTTP(newLog){
        return $.ajax({
          type: "POST",
          dataType: 'json',
          url: 'https://pdit-backend-jcskillings.c9.io/logs.json',
          data: newLog,
          contentType: 'application/json'
          //success: function(data){
          //  alert("PUT return: "+ JSON.stringify(data));
          //}
        
          });
      }
      
      function addLogCallback(data){
        //alert("addLog callback data: " + JSON.stringify(data));
        
        // need to call reload
        window.location.reload();
      }
      
      //ajax to delete a bill
      function deleteBillHTTP(billId){
        return $.ajax({
          type: "DELETE",
          dataType: 'json',
          //url: 'https://pdit-backend-jcskillings.c9.io/bills/' +billId+ '.json',
          url: backendURL+'bills/'+billId+'.json',
          contentType: 'application/json'
          //success: function(data){
          //  alert("PUT return: "+ JSON.stringify(data));
          //}
        
          });
      }
      
      function deleteBillCallback(data){
        //alert("deleteBill callback data: " + JSON.stringify(data));
        window.location.reload();
      }
      //======================================================
      function checkValidDate(year, month, day) {
        var daysInCurrent;
        month = parseInt(month);
        year = parseInt(year);
        day = parseInt(day);
        var isLeap =new Date(year, 1, 29).getMonth() == 1;
        if (month == 1 || month == 3 || month==5||month==7||month==8||month==10||month==12){
          daysInCurrent = 31;
        }
        else if(month==4||month==6||month==9||month==11){
          daysInCurrent = 30;
        }
        else{
          if(isLeap) daysInCurrent = 29;
          else daysInCurrent = 28;
        }
        if(day<=daysInCurrent) return true;
        else return false;
        
      } // end checkValidDate ===================================================================
      
      function doesNameExist(unparsed, findName) {
        var thisObj = JSON.parse(unparsed);
        var thisLength = thisObj.bills.length;
        for (var o = 0; o < thisLength; o++){
          var tempName = thisObj.bills[o].name;
          if(findName == tempName) {
            return true;
          }
        }
        return false;
      } //end does nameExist ==================================
      //======================================================
      $('#saveBtn').click( function() { // saves an newly added bill 
        //alert("entereing saveBtn");
        $('#saveBtn').css('visibility','hidden');
        var name = document.getElementById("billname").value;
        updateBillsNoPaid();
        //alert("returned from updateBillsNoPaid in saveBtn");
        if(doesNameExist(allBills, name) == true) {
          alert("You may not have multiple bills with the same name");
          return;
        }
        
        var currDate = Date();
        var currTZ = currDate.substring(29, 33);
        
        var year = document.getElementById("year").value;
        var month = document.getElementById("month").value;
        //alert("monthe from field is: " + month);
        var day = document.getElementById("day").value;
        var billDueDate = Date(year, month, day);
        //alert("billduedate : " + billDueDate.toString());
        var valid = checkValidDate(year, month, day);
        if(valid == false) {
          alert("You have entered an invalid day for the selected month");
          return;
        }
        
        var date = year +"-"+ month+"-"+day;
          
        var ampm = document.getElementById("ampm").value;
        var hour = document.getElementById("hour").value;
        var minute = document.getElementById("minute").value;
        var time;
        if(ampm == "am" && hour != "12") {
          time = hour + ":" + minute + ":00";
        }
        else if (ampm == "pm" && hour != "12") {
          hour = parseInt(hour) + 12;
          time = hour + ":" + minute + ":00";
          //alert("in else if parseint time: " + time);
        }
        else {
          if(ampm == "am") time = "00:" + minute + ":00";
          else time = "12:" + minute + ":00";
        }
        
        var dueDate = date + " "+ time +" +"+currTZ;
        var moDecr = MonthDecrement(month);
        dueDate = new Date(year,moDecr,day,hour,minute);
        //alert("dueDate : " + dueDate);
        var method1 = document.getElementById("method1").checked;
        var method2 = document.getElementById("method2").checked;
        var method3 = document.getElementById("method3").checked;
        var method4 = document.getElementById("method4").checked;
        
        var notifs = "";
        if (method1 == true) notifs = methods[0] +",";
        else notifs = ",";
        if (method2 == true) notifs = notifs + methods[1] +",";
        else notifs = notifs +",";
        if (method3 == true) notifs = notifs + methods[2] +",";
        else notifs = notifs + ",";
        if (method4 == true) notifs = notifs + methods[3];
        
        var category = notifs;
        var loginPage = document.getElementById("url").value;
        
        var repeat;
        if(document.getElementById("never").checked == true) repeat = "Never";
        else if(document.getElementById("weekly").checked == true) repeat = "Weekly";
        else if(document.getElementById("monthly").checked == true) repeat = "Monthly";
        else if(document.getElementById("biweekly").checked == true) repeat = "Biweekly";
        else {
          var r = parseInt(document.getElementById("customInput").value);
          if (r==1||r==2||r==3||r==4||r==5||r==6||r==7||r==8||r==9||r==10||r==11||r==12) repeat = r;
          else repeat = "Never";
        }
        var amountLo = document.getElementById("amountLo").value;
        //alert("new amountLo in saveBtn:"+ amountLo);
        var amountHi = document.getElementById("amountHi").value;
        
        if(amountLo == null || amountLo == ""){
          amountLo = amountHi;
        }
        if(amountHi == null || amountHi == "") {
          amountHi = amountLo;
        }
        
        var currUser = JSON.parse(getCookie("currUser"));
        var user_name = currUser.username; // changed from userName
        
        var reminder1days = document.getElementById("reminder1days").value;
        var reminder1hours = document.getElementById("reminder1hours").value;
        var reminder2days = document.getElementById("reminder2days").value;
        var reminder2hours = document.getElementById("reminder2hours").value;
        var reminder1;
        var reminder2;
        if(reminder1days == "00" && reminder1hours == "00") {
          //reminder1 = getDateTime(1983,1,1,0,0,"0000",0,0); 
          //reminder1 = Date(1983,1,1,0,0);
          reminder1 = dueDate;
          //alert("saveBTN | reminder 1 is: " + JSON.stringify(reminder1));
          
        }
        //else reminder1 = getDateTime(year, month, day, hour, minute, currTZ, reminder1days, reminder1hours);
        else reminder1 = Date(year, month,day,hour,minute);
        //alert("saveBtn  |  reminder 1 is: " + reminder1 + " | " + reminder1.toString());
        if(reminder2days == "00" && reminder2hours == "00") {
          //reminder2 = getDateTime(1983,1,1,0,0,"0000",0,0);
          reminder2 = dueDate;
        }
        //else reminder2 = getDateTime(year, month, day, hour, minute, currTZ, reminder2days, reminder2hours);
        else reminder2 = Date(year,month,day,hour,minute);
        var paymentType = document.getElementById("paymentType").value;
        var userJ = JSON.parse(getCookie("currUser"));
        var user_id = userJ.id;
        var newBill = new Bill(name, category, paymentType, loginPage, dueDate, repeat, amountLo, amountHi, user_id, user_name, reminder1, reminder2);
        
        var stringy = JSON.stringify(newBill); // stringy represents the individual bill object 
        //alert("here is stringy inside saveBtn click:" + stringy);
        
        var tempBills = allBills.substring(0, allBills.length - 2);
        if (numBills == 0){
          tempBills = '{"bills":[' + stringy + "]}"; // adding stringy to tempbills Json string if bills empty 
        }
        else {
          tempBills = tempBills + "," + stringy + "]}"; // otherwise concatenate to tempBills
        }
        
        var catLength = category.length;
        if(catLength == 3) category = "None selected";
        else {
          while(category.charAt(catLength-1) == ","){
            category = category.substring(0, catLength-1);
            catLength = category.length;
          }
          while(category.charAt(0) == ","){
            category = category.substring(1, catLength);
            catLength = category.length;
          }
        }
        
        var find = ",,";
        while(category.indexOf(find) != -1){
          var temp1 = category.substring(0, category.indexOf(find));
          var temp2 = category.substring(category.indexOf(find)+1, category.length);
          category = temp1 + temp2;
        }
        var sent;
        var ending ="";
        if(category == "None selected") {
          sent = "";
          ending = " You will recieve no notifications for this bill!(You have none selected)";
        }
        else sent = " to be sent to your " + category;
        //dueDate = dueDate.substring(0, dueDate.length - 9);
        //alert("whtf is in dueDate: " + dueDate.toString());
        //var tyear = dueDate.substr(0, 4);
        var tyear = dueDate.getFullYear();
        //var tdate = dueDate.substr(5, 5);
        var tdate = dueDate.getDate();
        tdate = tdate + "-" + tyear;
        //var ttime = dueDate.substr(dueDate.length - 5, 5);
        
        //var currHours = parseInt(ttime.substr(0, 2));
        var currHours = dueDate.getHours();
        var tampm;
        if (currHours >=1 && currHours <= 12){
          tampm = " a.m.";
        }
        else if (currHours >= 13){
          currHours = currHours -12;
          tampm = " p.m.";
        }
        else {
          currHours = 1;
          tampm = " a.m.";
        }
        //ttime = currHours + ttime.substr(2, 3) + tampm;
        var ttime = currHours + dueDate.getMinutes() + tampm;
        addNL("You added a new "+name+sent+" due on " + tdate + " at " + ttime+"!" + ending, "add bill");
        numBills++;
        
        //setCookie("allBills",updateWithPaid(tempBills),30);
        $('#addBill').css('visibility','visible');
        // call addBillHTTP
        //alert("call addBill with stingy = " + stringy);
        addBillHTTP(stringy).done(addBillCallback);
        //window.location.replace("billaccounts.html");
      }); //end $saveBtn =========================================================================
      
      function setCookie(cname,cvalue,exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname+"="+cvalue+"; "+expires;
      }
      
      //======================================================
      function reverse(year, month, day, hour, passedR) { //undoes getDateTime, returns [days,hours]
        var finalRD;
        var finalRH;
        var pyear = parseInt(passedR.substr(0, 4));
        var pmonth = parseInt(passedR.substr(5, 2));
        var pday = parseInt(passedR.substr(8, 2));
        var phour = parseInt(passedR.substr(11, 2));
        
        hour = parseInt(hour);
        year = parseInt(year);
        month = parseInt(month);
        day = parseInt(day);
        
        var isLeap =new Date(year, 1, 29).getMonth() == 1;
        var daysInPrev;
        
        if(month == 5 || month == 7 || month == 10 || month == 12) {
          daysInPrev = 30;
        }
        
        else if(month == 4 || month == 6 || month ==11 || month == 9 || month == 1 || month == 8 || month ==2) {
          daysInPrev = 31;
        }
        else{
          if(isLeap == true) daysInPrev = 29;
          else daysInPrev = 28;
        }
        
        if(hour - phour >= 0) {
          finalRH = hour - phour;
        }
        else {
          finalRH = hour - phour + 24;
          pday = pday + 1;
        }
        if(day - pday >= 0){
          finalRD = day - pday;
        }
        else{
          finalRD = day - pday + daysInPrev;
        }
        
        if(finalRD < 10) finalRD = "0" +finalRD;
        if(finalRH < 10) finalRH = "0" +finalRH;
        return [finalRD, finalRH];
      } // end reverse //======================================================
      //======================================================
      //returns dateTime for reminder given dueDate of bill and reminderdays+hours
      function getDateTime(year, month, day, hour, minute, TZ, reminderDays, reminderHours) {
        var finalYear;
        var finalMonth;
        var finalDay;
        var finalHour;
        var daysInPrev;
        
        year = parseInt(year);
        month = parseInt(month);
        hour = parseInt(hour);
        reminderDays = parseInt(reminderDays);
        reminderHours = parseInt(reminderHours);
        var isLeap =new Date(year, 1, 29).getMonth() == 1;
        
        if(month == 5 || month == 7 || month == 10 || month == 12) {
          daysInPrev = 30;
        }
        
        else if(month == 4 || month == 6 || month ==11 || month == 9 || month == 1 || month == 8 || month ==2) {
          daysInPrev = 31;
        }
        else{
          if(isLeap == true) daysInPrev = 29;
          else daysInPrev = 28;
        }
 
        if(hour - reminderHours >= 0) {
          finalHour = hour - reminderHours;
          if(finalHour <10 && finalHour >=0){
            finalHour = "0" + finalHour;
          }
        }
        else {
          finalHour = hour - reminderHours + 24;
          day = day-1;
        }
        if(day - reminderDays >= 1) {
          finalDay = day - reminderDays;
          if(finalDay <10 && finalDay >=1){
            finalDay = "0" + finalDay;
          }
        }
        else {
          month = month -1;
          finalDay = day - reminderDays + daysInPrev;
        }
        if(month > 0){
          finalMonth = month;
          finalYear = year;
          if(finalMonth <10 && finalMonth >0){
            finalMonth = "0" + finalMonth;
          }
        }
        else {
          finalMonth = 12;
          finalYear = year - 1;
        }
        
        var date = finalYear+"-"+finalMonth+"-"+finalDay;
        var time = finalHour +":"+minute+":00";
        var toReturn = date + " " + time + " +" + TZ;
        return toReturn;
      } //end getDateTime ======================================================
      
      function changeMonthToNumber(name) {
        if (name == "Jan") return 1;
        else if (name == "Feb") return 2;
        else if (name == "Mar") return 3;
        else if (name == "Apr") return 4;
        else if (name == "May") return 5;
        else if (name == "Jun") return 6;
        else if (name == "Jul") return 7;
        else if (name == "Aug") return 8;
        else if (name == "Sep") return 9;
        else if (name == "Oct") return 10;
        else if (name == "Nov") return 11;
        else if (name == "Dec") return 12;
      }
      function MonthNumToVal(num) { //errors in how month is used in places
        var month = new Array();
        month[0] = "01";
        month[1] = "02";
        month[2] = "03";
        month[3] = "04";
        month[4] = "05";
        month[5] = "06";
        month[6] = "07";
        month[7] = "08";
        month[8] = "09";
        month[9] = "10";
        month[10] = "11";
        month[11] = "12";
        return month[num];
      }
      function MonthDecrement(mo){//errors in how month is used in places
        var moInt = parseInt(mo)
        var month = new Array();
        month[0] = "00";
        month[1] = "00";
        month[2] = "01";
        month[3] = "02";
        month[4] = "03";
        month[5] = "04";
        month[6] = "05";
        month[7] = "06";
        month[8] = "07";
        month[9] = "08";
        month[10] = "09";
        month[11] = "10";
        month[12] = "11";
        return month[moInt];
      }
      function RubyDateToJS(rubyDate){
        //alert("rubydate: " + rubyDate + " tostr: " + rubyDate.toString() );
        var year = rubyDate.substring(0,4);
        var month = rubyDate.substring(6,7);
        if (month < 10){
          month ="0"+month;
        }
        if (month == -1){
          month =12;
        }
        if (day < 10){
          day = "0"+day;
        }
        if (hour < 10){
          hour = "0"+hour;
        }
        if (minute < 10){
          minute = "0"+minute;
        }
        var day = rubyDate.substring(8,10);
        var hour = rubyDate.substring(11,13);
        var minute = rubyDate.substring(14,16);
        var dt = new Date(year,month,day,hour,minute);
        var offset = dt.getTimezoneOffset()
        //alert("offset (should be 300: " + offset);
        dt.setMinutes(dt.getMinutes() - offset);
        hour = dt.getHours();
        minute = dt.getMinutes(); // after converision from UTC
        if (hour < 10){
          hour = "0"+hour;
        }
        if (minute < 10){
          minute = "0"+minute;
        }
        //alert("RUBY CONVERT year: " + year + " month: " + month + " day: " + day + " hour: " + hour + " minute: " + minute);
        //alert("Date: " + dt.toString());
        //return dt;
        return ""+year+"-"+month+"-"+day+"T"+hour+":"+minute+":00.000Z";
      }
    </script>
  </body>
</html>