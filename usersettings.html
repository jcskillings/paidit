<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paidit | Bill Analysis</title>
    <link rel="stylesheet" href="css/usersettings.css" />
    <link rel="stylesheet" href="css/foundation.css" />
    <link rel="stylesheet" href="css/test.css" />
    <link rel="shortcut icon" href="img/icon/checkMark.png"/>
    <script type="text/javascript" src="js/users.js"></script>
    <script type="text/javascript" src="js/responsive-tables.js"></script>
    <script src="js/vendor/modernizr.js"></script>
  </head>
  <body onload="getUserInfo()">
    
      
    <div class="icon-bar five-up">
      <a class="item" href="index.html">
        <img src="img/icon/homeIconG.png" height="20" width="20"  >
        <label class="show-for-medium-up">Home</label>
      </a>
      <a class="item" href="analysis.html">
        <img src="img/icon/chartsIconG.png" height="20" width="20">
        <label class="show-for-medium-up">Bill Analysis</label>
      </a>
      <a class="item" href="billaccounts.html">
        <img src="img/icon/billIconG.png" height="20" width="20">
        <label class="show-for-medium-up">Bills</label>
      </a>
      <a class="item" href="notificationslog.html">
        <img src="img/icon/smsIconG.png" height="20" width="20">
        <label class="show-for-medium-up">Notification Log</label>
      </a>
      <a class="item" href="usersettings.html" id="settings">
        <img src="img/icon/gearIconG.png" height="20" width="20">
        <label class="show-for-medium-up" id="settingstext">Settings</label>
      </a>
    </div>
    
  <div class="container navigation" style = "width:70%; margin:2% 15% 0% 15%">
   
        <div class="left">
          <h2><b>Welcome to Settings!</b></h2>
          <table class="large-20 columns" id="userTable" name="userTable">
            <tr>
              <th>Username:</th>
              <td><input id="username" type="text" placeholder="username" name="username" /></td>
            </tr>
            <tr>
              <th>First Name:</th>
              <td><input id="firstname" type="text" placeholder="firstname" name="firstname" /></td>
            </tr>
            <tr>
              <th>Lase Name:</th>
              <td><input id="lastname" type="text" placeholder="lastname" name="lastname" /></td>
            </tr>
            <tr>
              <th>Password:</th>
              <td><input id="password" type="text" placeholder="password" name="password" /></td>
            </tr>
            <tr>
              <td></td>
              <td><button style="width:100%;" onClick="saveUser()" id="save">Save User</button></td>
            </tr>
          </table>
      </div>

  
      
        <div class="right">
          <h2>
          <div class = "left">
            
          <ul class="button-group radius even-1 " id="verificationButton">
            <a href="#" data-reveal-id="verModal" class="button clearRegForm">Enter Verification Code Here</a>
          </ul>
          
          </div>
          <div class = "right">
            <ul class="button-group radius even-1 ">
            <button onClick="logout()" id="logout">Logout</button>
            </ul>
          </div>
          </h2>
          <div class="clear"></div>
          <br/>
          
          <br/>
          
          <table style="width:100%" id="userTable2" name="userTable2">
            
            <tr>
              
              <td><input id="email" type="text" placeholder="email" name="email" /></td>
              <th>:Email</th>
            </tr>
            <tr>
              
              <td><input id="phone" type="text" placeholder="phone" name="phone" /></td>
              <th>:Phone Number</th>
            </tr>
            <tr>
              
              <td><button style="width:100%;" onClick="saveNotifs()" id="save">Save Phone/Email</button></td>
              <td></td>
            </tr>
          </table>
      </div>

 
    <hr />
    
    <!--  verification modal-->
    <div div id="verModal" class="reveal-modal tiny" data-reveal aria-labelledby="Verification" aria-hidden="true" role="dialog">
      <div class="row">
          <div class="large-6 large-centered columns">
            <a><img src="img/logoSm.png" /></a>
          </div>
        </div>
      <form id="verForm" data-abide name='verForm' onsubmit="return validateForm()" method="post">
        
        <div class="row">
          <div class="large-6 large-centered columns">
            <label></br>Enter 10-digit code below
              <input type="text" placeholder="12ab34cd56" id='verCode' name='verCode'/>
            </label>
          </div>
        </div>
        <div class="row">
          <div class="large-6 large-centered columns">
            <input href="#" type="submit" class="radius button" value="Submit Code"/>
          </div>
        </div>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
      </form>
    </div>     <!--  verification modal-->
    
    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    <script type = "text/javascript"> 
      $(document).foundation();
      
      var userName;
      var firstName;
      var lastName;
      var email;
      var phone;
      var password;
      var notifs;
      var numNotifs;
      
      function getUserInfo(){
        var currUser = JSON.parse(getCookie("currUser"));
        firstName = currUser.firstName;
        userName = currUser.userName;
        firstName = currUser.firstName;
        lastName = currUser.lastName;
        password = currUser.password;
        //email = currUser.email;
        //phone = currUser.phone;
        notifs = JSON.parse(getCookie("NM"));
        numNotifs = notifs.length;
        //alert(notifs.methods[0].destination);
        email = notifs.methods[0].destination;
        phone = notifs.methods[1].destination;
        document.getElementById("username").value= userName;
        document.getElementById("lastname").value= lastName;
        document.getElementById("firstname").value= firstName;
        document.getElementById("password").value= password;
        document.getElementById("email").value= email;
        document.getElementById("phone").value= phone;
      }
      
      function logout() {
        //var obj = JSON.parse(getCookie("allUsers"));
        //var test = getCookie("allUsers");
        //var numUsers = obj.users.length;
        setCookie("currUser", "", 30);
        //alert("before" + test);
        //obj.users[index].userStatus = "signed out";
        //obj = JSON.stringify(obj);
        //setCookie("allUsers", obj, 30);
        //alert("after" + obj);
        window.location.replace("splash.html");
        return;
      }
      
      function setCookie(cname,cvalue,exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname+"="+cvalue+"; "+expires;
      }

      function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) {
              return c.substring(name.length, c.length);
            }
          }
        return "";
      }
      
      function validateForm() {   
      var code = document.forms["verForm"]["verCode"].value;
        if (code == null || code == "") {
          alert("Verification Code must be filled out to submit");
          return false;
        } 
        else {
          if (code.length < 10 || code.length > 10){
            alert("Code must be of length 10!");
            return false;
          }
        }
      }
      
      // Bill object constructor
      function User(userName, email, firstName, lastName, phone,  password){
        this.userName = userName;
        this.email = email;
        this.firstName = firstName;
        this.lastName = lastName;
        this.phone = phone;
        this.password = password;
      }
      
      function Method(type, destination, carrier, verified) {
        this.type = type;
        this.destination = destination;
        this.carrier = carrier;
        this.verified = verified;
      }
      
      function Log(info, date, time) {
        this.info = info;
        this.date = date;
        this.time = time;
      }
      
      function addNL(message){
        
        var currDate = Date();
        var currTime = currDate.substring(16, 24);
        currDate = currDate.substring(4, 15);
        var newLog = new Log(message, currDate, currTime);
        var stringy = JSON.stringify(newLog);
        var NL = (getCookie("NL"));
        var numLogs = NL.length;
        var temp = NL.substring(0, NL.length - 2);
        if (numLogs == 0) {
          NL = temp + stringy + "]}";
        }
        else{
          NL = temp + "," + stringy + "]}";
        }
        setCookie("NL",NL,30);
      }
      
      function saveNotifs(){
        var email1 = document.getElementById("email").value;
        var phone1 = document.getElementById("phone").value;
        var newMessage = "";
        if(email==email1 && phone==phone1){
          alert("No changes were made/saved!");
          return;
        }
        else {
          if(email != email1) {
            newMessage = "You changed your email address";
            if(phone != phone1) newMessage = "You changed your email address and phone number";
          }
          else{
            newMessage = "You changed your phone number";
          }
          var update = new User(userName, email1, firstName, lastName, phone1, password);
          var stringy = JSON.stringify(update);
          setCookie("currUser", stringy, 30);
          
          var method1 = new Method("email", email1, notifs.methods[0].carrier , notifs.methods[0].verified);
          var method2 = new Method("phone", phone1, notifs.methods[1].carrier , notifs.methods[1].verified);
          var stringy1 = JSON.stringify(method1);
          var stringy2 = JSON.stringify(method2);
          var nM = '{"methods":[' + stringy1 + "," + stringy2 + "]}";
          setCookie("NM", nM, 30);
          addNL(newMessage);
          window.location.reload();
        }
      }
      
      function saveUser(){
        //var notifs = [];
        var userName1 = document.getElementById("username").value;
        //alert(name);
        //var email1 =  document.getElementById("email").value;
        //alert(dueDate);
        var firstName1 = document.getElementById("firstname").value;
        var lastName1 = document.getElementById("lastname").value;
        //var phone1 = document.getElementById("phone").value;
        //alert(email);
        var password1 = document.getElementById("password").value;
        
        var newMessage = "";
        var numChanged = 0;
        
        if(userName == userName1 && firstName == firstName1 &&
          lastName==lastName1 && password==password1){
          alert("No changes were made/saved!");
          return;
        }
        else{
          if(userName != userName1) {
            newMessage=newMessage + "You changed your username";
            numChanged++;
          }
          if(firstName!=firstName1){
            if (numChanged == 0) {
              newMessage = "You changed your first name";
              numChanged++;
            }
            else {
              newMessage = newMessage + ", first name";
            }
          }
          if(lastName!= lastName1) {
            if (numChanged == 0) {
              newMessage = "You changed your last name";
              numChanged++;
            }
            else {
              newMessage=newMessage+", last name";
            }
          }
          if(password!=password1) {
            if (numChanged == 0) {
              newMessage = "You changed your password";
              numChanged++;
            }
            else {
              newMessage = newMessage +", password";
            }
          }
          var update = new User(userName1, email, firstName1, lastName1, phone, password1);
          var stringy = JSON.stringify(update);
          setCookie("currUser", stringy, 30);
          addNL(newMessage);
          window.location.reload();
        }
        
      }
      
    </script>
    
  </body>
</html>